<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Admin – brugere</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
        }

        h1 {
            margin-bottom: 10px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            font-size: 14px;
        }

        th {
            background: #f5f5f5;
            text-align: left;
        }

        .error {
            color: red;
            margin-top: 10px;
        }

        .success {
            color: green;
            margin-top: 10px;
        }

        form {
            border: 1px solid #ddd;
            padding: 12px;
            margin-top: 20px;
        }

            form h2 {
                margin-top: 0;
            }

        label {
            display: block;
            margin-top: 8px;
        }

        input, select {
            padding: 6px;
            width: 100%;
            box-sizing: border-box;
            margin-top: 3px;
        }

        button {
            margin-top: 10px;
            padding: 8px 12px;
        }

        /* --- Search UI (from Copilot) --- */
        .search-panel {
            border: 1px solid #ddd;
            padding: 12px;
            margin-top: 12px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .details {
            margin-top: 8px;
        }

            .details table {
                margin-top: 8px;
            }

        .muted {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>Admin – brugere</h1>
        <button id="logoutBtn">Log ud</button>
    </div>

    <!-- SEARCH (under heading) -->
    <div class="search-panel">
        <h2 style="margin:0 0 6px 0;">Search</h2>
        <div class="muted">Type min. 2 tegn. Klik et forslag for at vise hele objektet.</div>

        <div class="search-grid">
            <div>
                <label>SQL search</label>
                <input id="sqlSearch" list="sqlSuggestions" placeholder="Søg i SQL..." />
                <datalist id="sqlSuggestions"></datalist>
                <div id="sqlDetails" class="details"></div>
            </div>

            <div>
                <label>Mongo search (companies)</label>
                <input id="mongoSearch" list="mongoSuggestions" placeholder="Søg i Mongo (companies)..." />
                <datalist id="mongoSuggestions"></datalist>
                <div id="mongoDetails" class="details"></div>
            </div>

            <div>
                <label>Neo4j search</label>
                <input id="neoSearch" list="neoSuggestions" placeholder="Søg i Neo4j..." />
                <datalist id="neoSuggestions"></datalist>
                <div id="neoDetails" class="details"></div>
            </div>
        </div>
    </div>

    <div class="error" id="error"></div>
    <div class="success" id="success"></div>

    <!-- Tabel med eksisterende brugere -->
    <table id="usersTable" style="display:none;">
        <thead>
            <tr>
                <th>Id</th>
                <th>Email</th>
                <th>Rolle</th>
                <th>Aktiv</th>
                <th>Employee ID</th>
                <th>Slet</th>
            </tr>
        </thead>
        <tbody id="usersBody"></tbody>
    </table>

    <!-- Form til at oprette ny bruger -->
    <form id="createUserForm">
        <h2>Opret ny bruger (AppUser + Employee + Person)</h2>

        <h3>Login / AppUser</h3>
        <label>
            Email (arbejds-mail / login)
            <input type="email" id="newEmail" required />
        </label>

        <label>
            Password (midlertidigt)
            <input type="password" id="newPassword" required />
        </label>

        <label>
            Rolle
            <select id="newRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
            </select>
        </label>

        <h3>Person-oplysninger</h3>
        <label>
            Fornavn
            <input type="text" id="personFirstName" />
        </label>

        <label>
            Efternavn
            <input type="text" id="personLastName" />
        </label>

        <label>
            Privat email
            <input type="email" id="personPrivateEmail" />
        </label>

        <label>
            Privat telefon
            <input type="text" id="personPrivatePhone" />
        </label>

        <label>
            CPR
            <input type="text" id="personCpr" />
        </label>

        <label>
            Erfaring (år)
            <input type="number" id="personExperience" min="0" />
        </label>

        <label>
            Education ID
            <input type="number" id="personEducationId" min="1" />
        </label>

        <h3>Employee-oplysninger</h3>
        <label>
            Company ID
            <input type="number" id="employeeCompanyId" min="1" required />
        </label>

        <label>
            Employee telefon
            <input type="text" id="employeePhone" />
        </label>

        <label>
            Department ID
            <input type="number" id="employeeDepartmentId" min="1" />
        </label>

        <label>
            Position ID
            <input type="number" id="employeePositionId" min="1" />
        </label>

        <button type="submit">Opret bruger</button>
    </form>

    <script>
        const apiBaseUrl = window.location.origin;
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const usersTable = document.getElementById('usersTable');
        const usersBody = document.getElementById('usersBody');

        // LOGOUT
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('email');
            localStorage.removeItem('role');
            window.location.href = 'login.html';
        });

        // Hvis ikke logget ind → login
        if (!token) {
            window.location.href = 'login.html';
        }

        // Hvis ikke admin → væk herfra
        if (role !== 'admin') {
            errorDiv.textContent = "Du skal være admin for at se denne side.";
        } else {
            loadUsers();
        }

        // ---- SEARCH helpers (from Copilot) ----
        function debounce(fn, ms) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), ms);
            };
        }
        function renderObjectAsTable(obj) {
            if (!obj || typeof obj !== "object") return "<div>(no data)</div>";

            // Hvis backend returnerer en liste, så tag første element
            if (Array.isArray(obj)) {
                if (obj.length === 0) return "<div>(empty)</div>";
                obj = obj[0];
            }

            let keys = Object.keys(obj);
            if (keys.length === 0) return "<div>(empty)</div>";

            // Find ID-key (id, Id, ID)
            const idKey = keys.find(k => k.toLowerCase() === "id");

            // Fjern idKey fra keys og læg den først
            keys = keys.filter(k => k !== idKey);
            const orderedKeys = idKey ? [idKey, ...keys] : keys;

            const header = orderedKeys.map(k => `<th>${k}</th>`).join("");
            const row = orderedKeys.map(k => `<td>${obj[k] ?? ""}</td>`).join("");

            return `
    <table>
      <thead><tr>${header}</tr></thead>
      <tbody><tr>${row}</tr></tbody>
    </table>
  `;
        }

        async function fetchJson(url) {
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function fetchSuggestions(endpoint, q) {
            const url = `${apiBaseUrl}${endpoint}?q=${encodeURIComponent(q)}&limit=10`;
            return await fetchJson(url);
        }

        const suggestionCache = { sql: [], mongo: [], neo: [] };

        function fillDatalist(datalistEl, items) {
            datalistEl.innerHTML = "";
            items.forEach(x => {
                const opt = document.createElement("option");
                opt.value = `${x.type}#${x.id} - ${x.label}`;
                datalistEl.appendChild(opt);
            });
        }

        function parseSelected(value) {
            const m = /^([^#]+)#(\d+)\s*-/.exec((value || "").trim());
            if (!m) return null;
            return { type: m[1], id: Number(m[2]) };
        }

        async function showSqlDetails(selection) {
            const detailsEl = document.getElementById("sqlDetails");
            detailsEl.innerHTML = "";

            const map = {
                company: "Company",
                department: "Department",
                disc_profile: "DiscProfile",
                education: "Education",
                employee: "Employee",
                person: "Person",
                position: "Position",
                project: "Project",
                task: "Task",
                social_event: "SocialEvent",
                stress_measure: "StressMeasure",
                task_evaluation: "TaskEvaluation",
                daily_task_log: "DailyTaskLog",
                projects_disc_profile: "ProjectsDiscProfile",
                app_user: "AppUser"
            };

            const controller = map[selection.type];
            if (!controller) {
                detailsEl.innerHTML = `<div>Unknown type: ${selection.type}</div>`;
                return;
            }

            try {
                const obj = await fetchJson(`${apiBaseUrl}/api/${controller}/${selection.id}`);
                detailsEl.innerHTML = renderObjectAsTable(obj);
            } catch (e) {
                detailsEl.innerHTML = `<div>Could not load SQL details (${e.message})</div>`;
            }
        }

        async function showMongoDetails(selection) {
            const detailsEl = document.getElementById("mongoDetails");
            detailsEl.innerHTML = "";

            if (selection.type !== "company") {
                detailsEl.innerHTML = `<div>Mongo supports only company for now.</div>`;
                return;
            }

            try {
                const obj = await fetchJson(`${apiBaseUrl}/api/mongo/companies/${selection.id}`);
                detailsEl.innerHTML = renderObjectAsTable(obj);
            } catch (e) {
                detailsEl.innerHTML = `<div>Could not load Mongo details (${e.message})</div>`;
            }
        }

        async function showNeoDetails(selection) {
            const detailsEl = document.getElementById("neoDetails");
            detailsEl.innerHTML = "";

            try {
                // NOTE: selection.type must match Neo4j label
                const obj = await fetchJson(`${apiBaseUrl}/api/Graph/node/${selection.type}/${selection.id}`);
                detailsEl.innerHTML = renderObjectAsTable(obj);
            } catch (e) {
                detailsEl.innerHTML = `<div>Could not load Neo details (${e.message})</div>`;
            }
        }

        const onSqlInput = debounce(async () => {
            const q = document.getElementById("sqlSearch").value.trim();
            if (q.length < 2) {
                suggestionCache.sql = [];
                fillDatalist(document.getElementById("sqlSuggestions"), []);
                return;
            }
            const items = await fetchSuggestions("/api/search/sql", q);
            suggestionCache.sql = items;
            fillDatalist(document.getElementById("sqlSuggestions"), items);
        }, 250);

        const onMongoInput = debounce(async () => {
            const q = document.getElementById("mongoSearch").value.trim();
            if (q.length < 2) {
                suggestionCache.mongo = [];
                fillDatalist(document.getElementById("mongoSuggestions"), []);
                return;
            }
            const items = await fetchSuggestions("/api/search/mongo", q);
            suggestionCache.mongo = items;
            fillDatalist(document.getElementById("mongoSuggestions"), items);
        }, 250);

        const onNeoInput = debounce(async () => {
            const q = document.getElementById("neoSearch").value.trim();
            if (q.length < 2) {
                suggestionCache.neo = [];
                fillDatalist(document.getElementById("neoSuggestions"), []);
                return;
            }
            const items = await fetchSuggestions("/api/search/neo", q);
            suggestionCache.neo = items;
            fillDatalist(document.getElementById("neoSuggestions"), items);
        }, 250);

        document.getElementById("sqlSearch").addEventListener("input", onSqlInput);
        document.getElementById("mongoSearch").addEventListener("input", onMongoInput);
        document.getElementById("neoSearch").addEventListener("input", onNeoInput);

        document.getElementById("sqlSearch").addEventListener("change", async (e) => {
            const selection = parseSelected(e.target.value);
            if (!selection) return;
            await showSqlDetails(selection);
        });

        document.getElementById("mongoSearch").addEventListener("change", async (e) => {
            const selection = parseSelected(e.target.value);
            if (!selection) return;
            await showMongoDetails(selection);
        });

        document.getElementById("neoSearch").addEventListener("change", async (e) => {
            const selection = parseSelected(e.target.value);
            if (!selection) return;
            await showNeoDetails(selection);
        });

        // ---- EXISTING USERS LIST ----
        async function loadUsers() {
            errorDiv.textContent = "";
            successDiv.textContent = "";

            try {
                const response = await fetch(`${apiBaseUrl}/api/AppUser`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    errorDiv.textContent = "Kunne ikke hente brugere. Status: " + response.status;
                    return;
                }

                const users = await response.json();
                usersTable.style.display = "";
                usersBody.innerHTML = "";

                users.forEach(user => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                            <td>${user.is_active ? 'Ja' : 'Nej'}</td>
                            <td>${user.employee_id ?? ''}</td>
                        `;

                    if (user.employee_id) {
                        tr.style.cursor = 'pointer';
                        tr.title = 'Klik for at redigere employee og projekter';
                        tr.addEventListener('click', () => {
                            window.location.href = `employee.html?employeeId=${user.employee_id}`;
                        });
                    }

                    const deleteTd = document.createElement('td');
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.textContent = 'Slet';

                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();

                        const confirmed = confirm(`Er du sikker på, at du vil slette bruger #${user.id}?`);
                        if (!confirmed) return;

                        try {
                            const res = await fetch(`${apiBaseUrl}/api/AppUser/${user.id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            if (!res.ok) {
                                errorDiv.textContent = "Kunne ikke slette bruger. Status: " + res.status;
                                return;
                            }

                            successDiv.textContent = `Bruger #${user.id} er markeret som slettet.`;
                            await loadUsers();
                        } catch (err) {
                            console.error(err);
                            errorDiv.textContent = "Der opstod en fejl ved sletning.";
                        }
                    });

                    deleteTd.appendChild(deleteBtn);
                    tr.appendChild(deleteTd);
                    usersBody.appendChild(tr);
                });

            } catch (err) {
                console.error(err);
                errorDiv.textContent = "Der opstod en fejl ved hentning af brugere.";
            }
        }

        // Håndtér oprettelse af ny bruger (AppUser + Employee + Person)
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            errorDiv.textContent = "";
            successDiv.textContent = "";

            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const roleValue = document.getElementById('newRole').value;

            const firstName = document.getElementById('personFirstName').value;
            const lastName = document.getElementById('personLastName').value;
            const privateEmail = document.getElementById('personPrivateEmail').value;
            const privatePhone = document.getElementById('personPrivatePhone').value;
            const cpr = document.getElementById('personCpr').value;
            const experienceRaw = document.getElementById('personExperience').value;
            const educationRaw = document.getElementById('personEducationId').value;

            const companyIdRaw = document.getElementById('employeeCompanyId').value;
            const employeePhone = document.getElementById('employeePhone').value;
            const departmentRaw = document.getElementById('employeeDepartmentId').value;
            const positionRaw = document.getElementById('employeePositionId').value;

            if (!email || !password || !companyIdRaw) {
                errorDiv.textContent = "Email, password og company ID skal udfyldes.";
                return;
            }

            const body = {
                email: email,
                password: password,
                role: roleValue,
                first_name: firstName,
                last_name: lastName,
                private_email: privateEmail,
                private_phone: privatePhone,
                cpr: cpr,
                experience: experienceRaw ? parseInt(experienceRaw, 10) : null,
                education_id: educationRaw ? parseInt(educationRaw, 10) : null,
                employee_phone: employeePhone,
                company_id: parseInt(companyIdRaw, 10),
                department_id: departmentRaw ? parseInt(departmentRaw, 10) : null,
                position_id: positionRaw ? parseInt(positionRaw, 10) : null
            };

            try {
                const response = await fetch(`${apiBaseUrl}/api/AppUser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    if (response.status === 409) {
                        errorDiv.textContent = "Der findes allerede en bruger med den email.";
                        return;
                    }
                    if (response.status === 401) {
                        errorDiv.textContent = "Token er udløbet. Log ind igen.";
                        setTimeout(() => window.location.href = 'login.html', 1500);
                        return;
                    }
                    if (response.status === 403) {
                        errorDiv.textContent = "Du har ikke adgang til at oprette brugere.";
                        return;
                    }

                    errorDiv.textContent = "Kunne ikke oprette bruger. Status: " + response.status;
                    return;
                }

                successDiv.textContent = "Bruger + employee + person oprettet.";
                document.getElementById('createUserForm').reset();
                await loadUsers();
            } catch (err) {
                console.error(err);
                errorDiv.textContent = "Der opstod en fejl ved oprettelse af bruger.";
            }
        });
    </script>
</body>
</html>